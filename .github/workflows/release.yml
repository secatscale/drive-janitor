name: Build and Release
on:
  push:
    tags: ['v*']

jobs:
#--------------------------------------------------------------------
# 1. Compilation des binaires (Linux / macOS / Windows)
#--------------------------------------------------------------------
  build:
    strategy:
      fail-fast: false            # n’annule pas les autres builds au 1er échec
      matrix:
        include:
          # ── Linux / amd64 ────────────────────────────────────────
          - id: linux-amd64
            os: ubuntu-latest
            goos: linux
            goarch: amd64
            cc:   gcc
            pkgconfig: pkg-config
            yara_install: |
              sudo apt-get update
              sudo apt-get install -y pkg-config libyara-dev yara

          # ── Linux / arm64 (cross-compile) ────────────────────────
          # - id: linux-arm64
          #   os: ubuntu-latest
          #   goos: linux
          #   goarch: arm64
          #   cc:   aarch64-linux-gnu-gcc
          #   pkgconfig: aarch64-linux-gnu-pkg-config
          #   yara_install: |
          #     sudo dpkg --add-architecture arm64
          #     sudo apt-get update
          #     sudo apt-get install -y \
          #       gcc-aarch64-linux-gnu \
          #       pkg-config-aarch64-linux-gnu \
          #       libyara-dev:arm64

          # ── macOS / arm64 ────────────────────────────────────────
          - id: macos-arm64
            os: macos-14-arm64     # runner Apple Silicon natif
            goos: darwin
            goarch: arm64
            cc:   clang
            pkgconfig: pkg-config
            yara_install: brew install yara pkg-config

          # ── Windows / amd64 ──────────────────────────────────────
          # - id: windows-amd64
          #   os: windows-latest
          #   goos: windows
          #   goarch: amd64
          #   # MinGW-w64 est déjà présent sur le runner ; vcpkg fournit libyara
          #   cc:   x86_64-w64-mingw32-gcc
          #   pkgconfig: pkg-config
          #   yara_install: |
          #     choco install -y ninja
          #     vcpkg install --triplet x64-windows yara

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 1.24.1

      - name: Install YARA toolchain
        shell: bash
        run: ${{ matrix.yara_install }}

      - name: Build ${{ matrix.id }}
        shell: bash
        env:
          GOOS:   ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC:         ${{ matrix.cc }}
          PKG_CONFIG: ${{ matrix.pkgconfig }}
        run: |
          set -euo pipefail
          mkdir -p dist
          EXT=""
          [[ "${GOOS}" == "windows" ]] && EXT=".exe"
          go build -v -trimpath -o "dist/drivejanitor-${GOOS}-${GOARCH}${EXT}" ./main.go

      - name: Upload binaries
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#--------------------------------------------------------------------
# 2. Packaging .pkg macOS (s’appuie sur le binaire produit ci-dessus)
#--------------------------------------------------------------------
  build-pkg-macos:
    needs: build                                   # attend le job build
    runs-on: macos-14-arm64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 1.24.1

      - name: Install YARA
        run: brew install yara pkg-config

      - name: Build binary (darwin/arm64)
        run: |
          mkdir -p dist
          GOOS=darwin GOARCH=arm64 go build -trimpath -o dist/drivejanitor ./main.go

      - name: Build .pkg
        run: |
          PKGROOT=pkgroot
          mkdir -p $PKGROOT/usr/local/bin
          mkdir -p $PKGROOT/usr/local/etc/drivejanitor
          cp dist/drivejanitor $PKGROOT/usr/local/bin/
          cp config.yaml       $PKGROOT/usr/local/etc/drivejanitor/config.yaml
          pkgbuild --root $PKGROOT \
                   --identifier com.secatscale.drivejanitor \
                   --version ${{ github.ref_name }} \
                   --install-location / \
                   dist/drivejanitor-darwin.pkg

      - name: Upload .pkg
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/drivejanitor-darwin.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
